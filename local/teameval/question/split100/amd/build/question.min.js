define(["local_teameval/question","jquery","core/str","local_teameval/formparse"],function(a,b,c,d){function e(a,b){return a.reduce(function(a,c,d){return d>=b?a:a+c},0)}function f(a,b){var c=100/(100-j*b);return c*a-j*c}function g(a,b){var c=100/(100-j*b);return(a+j*c)/c}function h(a,b){var c=a.map(function(a){return Math.round(a)});b=b||[];var d=e(c);if(100!=d){var f=d-100,g=a.map(function(a,b){return{i:b,v:a}}),h=0>f?1:-1;g.sort(function(a,d){var e=-1!=b.indexOf(a.i),f=-1!=b.indexOf(d.i);return e!=f?e?-1:1:Math.abs(c[a.i]+h-a.v)-Math.abs(c[d.i]+h-d.v)});for(var i=0;i<Math.abs(f);i++){var j=g[i].i;c[j]+=h}}return c}function i(c,d,e,f,g,h,i){a.apply(this,arguments),this.self=f,this.context=i||{},this.pluginName="split100",this.container.find(".hundred").length&&(this.updateView(),this.initialiseSubmissionView()),b(window).on("resize",function(){this.updateView()}.bind(this))}var j=5;return i.prototype=Object.create(a.prototype),i.prototype.displayToReal=function(a){return f(a,this.sizes.length)},i.prototype.realToDisplay=function(a){return g(a,this.sizes.length)},i.prototype.showOverflow=function(a){var b=this.container.find(".overflows").children(".name").eq(a),c=this.container.find(".hundred").children(".split").eq(a);b.show();var d=c.position().left+c.width()/2,e=b.find("span").width()+20,f=this.container.find(".hundred").width(),g=f/2>d?["left","right"]:["right","left"],h=[];f>d+e&&h.push("left"),d-e>0&&h.push("right"),b.removeClass("left right middle"),b.css("margin-left",""),b.css("margin-right","");for(var i=0;i<g.length;i++){var j=g[i];if(-1!==h.indexOf(j)){switch(b.addClass(j),b.css("z-index",100-a),j){case"left":b.css("left",d-10+"px");break;case"right":b.css("right",f-d+"px")}break}}},i.prototype.updateView=function(a){if(this.context){var c=this.context.users.length;this.sizes||(this.sizes=this.context.users.map(function(a){return g(parseFloat(a.pct),c)},this));var d=this.container.find(".hundred");if(0!==d.length){this.sizes=this.sizes.map(function(a){return Math.max(a,j)});var f=e(this.sizes),i=this.sizes.map(this.displayToReal,this);if(100!=f){var k=e(i),l=100/k;i=i.map(function(a){return a*l}),this.sizes=i.map(this.realToDisplay,this)}for(var m=h(i,a),n=d.children(".split"),o=d.children(".handle"),p=0,q=0;q<this.sizes.length;q++){var r=this.sizes[q];n.eq(q).css({width:r+"%",left:p+"%"}).find(".name").show().end().find(".value").html(m[q]+"%"),p+=r,o.eq(q).css("left",p+"%");var s=n.get(q);s.scrollWidth>s.clientWidth||s.scrollHeight>s.clientHeight?(b(s).find(".split-label .name").hide(),this.showOverflow(q)):this.container.find(".overflows").children(".name").eq(q).hide()}}}},i.prototype.initialiseSubmissionView=function(){var a,c,d,f,g,h=this.container.find(".hundred");window.TouchEvent&&this.container.find(".handle").addClass("touch"),h.on("mousedown touchstart",".handle",function(e){if(!a&&(e.preventDefault(),a=b(e.target),f=b(e.delegateTarget).children(".handle").index(a),c=b(e.delegateTarget).offset(),d=b(e.delegateTarget).width(),e.originalEvent.touches&&(g=e.originalEvent.touches[0].identifier),-1==f))throw"The DOM tree is messed up; reload the page"}).on("mousemove touchmove",function(b){if(a){b.preventDefault();var h;if(b.pageX)h=b.pageX;else if(b.originalEvent.touches)for(var i=0;i<b.originalEvent.changedTouches.length;i++){var k=b.originalEvent.changedTouches[i];k.identifier==g&&(h=k.pageX)}if(void 0===h)return;var l=(h-c.left)/d*100,m=e(this.sizes,f+1),n=l-m,o=f,p=f+1;if(0>n){o=null;for(var i=f;i>=0;i--)if(this.sizes[i]>j){o=i;break}}if(n>0){p=null;for(var i=f+1;i<this.sizes.length;i++)if(this.sizes[i]>j){p=i;break}}null!==o&&null!==p&&(this.sizes[o]+=n,this.sizes[p]-=n),this.updateView([o,p])}}.bind(this)).on("mouseup mouseleave touchend touchcancel",function(b){b.preventDefault(),a=null,h.children(".split").css("color","")})},i.prototype.submissionView=function(){return a.prototype.submissionView.apply(this,arguments).done(function(){this.updateView(),this.initialiseSubmissionView()}.bind(this))},i.prototype.submissionContext=function(){return this.context},i.prototype.editingView=function(){var a={title:this.context.title,description:{format:1,text:this.context.description}};return this.editForm("\\teamevalquestion_split100\\forms\\edit_form",b.param(a),{})},i.prototype.save=function(a){var e=this.container.find("form"),f=d.serializeObject(e);this.context.title=f.title,this.context.description=f.description.text;var g=[this.self?"yourself":"exampleuser","exampleuser","exampleuser","exampleuser"].map(function(a,b){return{key:a,component:"teamevalquestion_split100",param:this.self?b:b+1}}),h=c.get_strings(g).then(function(a){var b=[20,10,15,55],c=[21,13,17,49],d=[0,21,34,51];this.context.users=a.map(function(a,e){return{name:a,id:-e,pct:b[e],width:c[e],left:d[e],rounded:b[e],first:0===e,self:this.self?0===e:!1}}.bind(this))}.bind(this)),i=this.saveForm(e,a);return b.when(h,i)},i.prototype.submit=function(a){if(!this.sizes)return a(),!0;for(var b=[],c=this.context.users.length-1;c>=0;c--){var d=this.context.users[c],e=this.sizes[c];d.pct=this.displayToReal(e),b.push({userid:d.id,pct:d.pct})}var f={teamevalid:this.teameval,questionid:this.questionID,percents:b};return a({methodname:"teamevalquestion_split100_submit_response",args:f}),!0},i});