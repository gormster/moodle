define(["local_teameval/question","jquery","core/str","local_teameval/formparse","local_teameval/editor"],function(a,b,c,d,e){function f(a,b){return a.reduce(function(a,c,d){return d>=b?a:a+c},0)}function g(a,b){var c=100/(100-k*b);return c*a-k*c}function h(a,b){var c=100/(100-k*b);return(a+k*c)/c}function i(a,b){var c=a.map(function(a){return Math.round(a)});b=b||[];var d=f(c);if(100!=d){var e=d-100,g=a.map(function(a,b){return{i:b,v:a}}),h=0>e?1:-1;g.sort(function(a,d){var e=-1!=b.indexOf(a.i),f=-1!=b.indexOf(d.i);return e!=f?e?-1:1:Math.abs(c[a.i]+h-a.v)-Math.abs(c[d.i]+h-d.v)});for(var i=0;i<Math.abs(e);i++){var j=g[i].i;c[j]+=h}}return c}function j(c,d,e,f,g,h,i){a.apply(this,arguments),this.self=f,this.context=i||{},this.pluginName="split100",this.container.find(".hundred").length&&(this.updateView(),this.initialiseSubmissionView()),b(window).on("resize",function(){this.updateView()}.bind(this))}var k=5;return j.prototype=Object.create(a.prototype),j.prototype.displayToReal=function(a){return g(a,this.sizes.length)},j.prototype.realToDisplay=function(a){return h(a,this.sizes.length)},j.prototype.showOverflow=function(a){var b=this.container.find(".overflows").children(".name").eq(a),c=this.container.find(".hundred").children(".split").eq(a);b.show();var d=c.position().left+c.width()/2,e=b.find("span").width()+20,f=this.container.find(".hundred").width(),g=f/2>d?["left","right"]:["right","left"],h=[];f>d+e&&h.push("left"),d-e>0&&h.push("right"),b.removeClass("left right middle"),b.css("margin-left",""),b.css("margin-right","");for(var i=0;i<g.length;i++){var j=g[i];if(-1!==h.indexOf(j)){switch(b.addClass(j),b.css("z-index",100-a),j){case"left":b.css("left",d-10+"px");break;case"right":b.css("right",f-d+"px")}break}}},j.prototype.updateView=function(a){if(this.context){var c=this.context.users.length;this.sizes||(this.sizes=this.context.users.map(function(a){return h(parseFloat(a.pct),c)},this));var d=this.container.find(".hundred");if(0!==d.length){this.sizes=this.sizes.map(function(a){return Math.max(a,k)});var e=f(this.sizes),g=this.sizes.map(this.displayToReal,this);if(100!=e){var j=f(g),l=100/j;g=g.map(function(a){return a*l}),this.sizes=g.map(this.realToDisplay,this)}for(var m=i(g,a),n=d.children(".split"),o=d.children(".handle"),p=0,q=0;q<this.sizes.length;q++){var r=this.sizes[q];n.eq(q).css({width:r+"%",left:p+"%"}).find(".name").show().end().find(".value").html(m[q]+"%"),p+=r,o.eq(q).css("left",p+"%");var s=n.get(q);s.scrollWidth>s.clientWidth||s.scrollHeight>s.clientHeight?(b(s).find(".split-label .name").hide(),this.showOverflow(q)):this.container.find(".overflows").children(".name").eq(q).hide()}}}},j.prototype.initialiseSubmissionView=function(){var a,c,d,e,g,h=this.container.find(".hundred");window.TouchEvent&&this.container.find(".handle").addClass("touch"),h.on("mousedown touchstart",".handle",function(f){if(!a&&(f.preventDefault(),a=b(f.target),e=b(f.delegateTarget).children(".handle").index(a),c=b(f.delegateTarget).offset(),d=b(f.delegateTarget).width(),f.originalEvent.touches&&(g=f.originalEvent.touches[0].identifier),-1==e))throw"The DOM tree is messed up; reload the page"}).on("mousemove touchmove",function(b){if(a){b.preventDefault();var h;if(b.pageX)h=b.pageX;else if(b.originalEvent.touches)for(var i=0;i<b.originalEvent.changedTouches.length;i++){var j=b.originalEvent.changedTouches[i];j.identifier==g&&(h=j.pageX)}if(void 0===h)return;var l=(h-c.left)/d*100,m=f(this.sizes,e+1),n=l-m,o=e,p=e+1;if(0>n){o=null;for(var i=e;i>=0;i--)if(this.sizes[i]>k){o=i;break}}if(n>0){p=null;for(var i=e+1;i<this.sizes.length;i++)if(this.sizes[i]>k){p=i;break}}null!==o&&null!==p&&(this.sizes[o]+=n,this.sizes[p]-=n),this.updateView([o,p])}}.bind(this)).on("mouseup mouseleave touchend touchcancel",function(b){b.preventDefault(),a=null,h.children(".split").css("color","")})},j.prototype.submissionView=function(){return a.prototype.submissionView.apply(this,arguments).done(function(){this.updateView(),this.initialiseSubmissionView()}.bind(this))},j.prototype.submissionContext=function(){return this.context},j.prototype.editingView=function(){var a={title:this.context.title,description:{format:1,text:this.context.description}};return this.editForm("\\teamevalquestion_split100\\forms\\edit_form",b.param(a),{})},j.prototype.save=function(a){var f=this.container.find("form");e.saveAll(f);var g=d.serializeObject(f);this.context.title=g.title,this.context.description=g.description.text;var h=[this.self?"yourself":"exampleuser","exampleuser","exampleuser","exampleuser"].map(function(a,b){return{key:a,component:"teamevalquestion_split100",param:this.self?b:b+1}}),i=c.get_strings(h).then(function(a){var b=[20,10,15,55],c=[21,13,17,49],d=[0,21,34,51];this.context.users=a.map(function(a,e){return{name:a,id:-e,pct:b[e],width:c[e],left:d[e],rounded:b[e],first:0===e,self:this.self?0===e:!1}}.bind(this))}.bind(this)),j=this.saveForm(f,a);return b.when(i,j)},j.prototype.submit=function(a){if(!this.sizes)return a(),!0;for(var b=[],c=this.context.users.length-1;c>=0;c--){var d=this.context.users[c],e=this.sizes[c];d.pct=this.displayToReal(e),b.push({userid:d.id,pct:d.pct})}var f={teamevalid:this.teameval,questionid:this.questionID,percents:b};return a({methodname:"teamevalquestion_split100_submit_response",args:f}),!0},j});