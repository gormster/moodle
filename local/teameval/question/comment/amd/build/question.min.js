define(["jquery","local_teameval/question","core/templates","core/notification","core/str","local_teameval/formparse"],function(a,b,c,d,e,f){function g(a,c,d,e,f,g,h){b.apply(this,arguments),this._self=e,this._editing=f,h=h||{},this._editingcontext=h.editingcontext||{_newquestion:!0},this._editinglocked=h.editinglocked||!1,this._submissioncontext=h.submissioncontext||{},this.pluginName="comment"}function h(){var b=this.container.find("textarea").filter(function(){return 0===a(this).val().trim().length});return b.length>0?this.container.parent().addClass("incomplete"):this.container.parent().removeClass("incomplete"),b.length>0}return g.prototype=new b,g.prototype.submissionContext=function(){return this._submissioncontext},g.prototype.submissionView=function(){return b.prototype.submissionView.apply(this,arguments)},g.prototype.editingContext=function(){return this._editingcontext},g.prototype.editingView=function(){return this.editForm("\\teamevalquestion_comment\\forms\\edit_form",a.param(this._editingcontext),{locked:this._editinglocked})},g.prototype.save=function(b){var c=this.container.find("form"),d=f.serializeObject(c);return this.saveForm(c,b).then(function(b){return e.get_strings([{key:"exampleuser",component:"local_teameval"},{key:"yourself",component:"local_teameval"}]).then(function(c){var e=[{userid:0,name:c[0]}];return this._self&&e.unshift({userid:-1,name:c[1],self:!0}),this._submissioncontext=a.extend({},d,{users:e}),this._submissioncontext.description=d.description.text,this._editingcontext=d,b}.bind(this))}.bind(this))},g.prototype.validateData=function(b){var c=a.Deferred(),d=function(c){return a(b).find('[name="'+c+'"]').val()};return 0===d("title").trim().length&&0===d("description").trim().length?e.get_string("titleordescription","teamevalquestion_comment").done(function(a){c.reject({invalid:!0,errors:{title:a,description:a}})}):c.resolve(),c.promise()},g.prototype.submit=function(b){var c=[];this.container.find(".comments textarea").each(function(){var b=a(this).data("touser"),d={};d.touser=b,d.comment=a(this).val(),c.push(d)}),b({methodname:"teamevalquestion_comment_submit_response",args:{teamevalid:this.teameval,id:this.questionID,comments:c}});var d=!1;return this._submissioncontext.optional&&(d=h()),!d},g});