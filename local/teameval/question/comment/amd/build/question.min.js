define(["jquery","local_teameval/question","core/ajax","core/templates","core/notification","core/str","local_teameval/formparse"],function(a,b,c,d,e,f,g){function h(a,c,d,e,f,g,h){b.apply(this,arguments),this._self=e,this._editing=f,h=h||{},this._editingcontext=h.editingcontext||{_newquestion:!0},this._editinglocked=h.editinglocked||!1,this._submissioncontext=h.submissioncontext||{},this.pluginName="comment"}function i(){var b=this.container.find("textarea").filter(function(){return 0===a(this).val().trim().length});return b.length>0?this.container.parent().addClass("incomplete"):this.container.parent().removeClass("incomplete"),b.length>0}return h.prototype=new b,h.prototype.submissionContext=function(){return this._submissioncontext},h.prototype.submissionView=function(){return b.prototype.submissionView.apply(this,arguments)},h.prototype.editingContext=function(){return this._editingcontext},h.prototype.editingView=function(){return this.editForm("\\teamevalquestion_comment\\forms\\edit_form",a.param(this._editingcontext),{locked:this._editinglocked})},h.prototype.save=function(b){var c=this.container.find("form"),d=g.serializeObject(c);return this.saveForm(c,b).then(function(b){return f.get_strings([{key:"exampleuser",component:"local_teameval"},{key:"yourself",component:"local_teameval"}]).then(function(c){var e=[{userid:0,name:c[0]}];return this._self&&e.unshift({userid:-1,name:c[1],self:!0}),this._submissioncontext=a.extend({},d,{users:e}),this._submissioncontext.description=d.description.text,this._editingcontext=d,b}.bind(this))}.bind(this))},h.prototype.validateData=function(b){var c=a.Deferred(),d=function(c){return a(b).find('[name="'+c+'"]').val()};return 0===d.title.trim().length&&0===d.description.trim().length?f.get_string("titleordescription","teamevalquestion_comment").done(function(a){c.reject({invalid:!0,errors:{title:a,description:a}})}):c.resolve(),c.promise()},h.prototype.submit=function(){var b=[];this.container.find(".comments textarea").each(function(){var c=a(this).data("touser"),d={};d.touser=c,d.comment=a(this).val(),b.push(d)});var d=c.call([{methodname:"teamevalquestion_comment_submit_response",args:{teamevalid:this.teameval,id:this.questionID,comments:b}}]),e=!1;return this._submissioncontext.optional&&(e=i()),d[0].then(function(){return{incomplete:e}})},h.prototype["delete"]=function(){var a=c.call([{methodname:"teamevalquestion_comment_delete_question",args:{teamevalid:this.teameval,id:this.questionID}}]);return a[0]},h});