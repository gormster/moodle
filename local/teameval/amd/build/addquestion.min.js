define(["jquery","jqueryui","core/str","core/templates","core/ajax","core/notification"],function(a,b,c,d,e,f){"use strict";var g,h,i,j,k,l,m,n,o;return{preAddQuestion:function(b){var c=a('<ul class="local-teameval-question-dropdown" />');a.each(h,function(b,d){var e=a("<li />");e.html("<a>"+d.displayname+"</a>"),e.data("type",d.name),c.append(e)}),a(".local-teameval-containerbox").append(c);var d=k.position();c.css("top",d.top+"px"),c.css("right","0px"),b.stopPropagation();var e=this;a(document).one("click",function(b){if(a(b.target).closest(".local-teameval-question-dropdown").length>0){var d=a(b.target).closest("li").data("type"),f=e.addQuestion(d);e.editQuestion(f,!0)}c.remove()})},addQuestion:function(b){var c=a('<li class="local-teameval-question" />');c.data("questiontype",b);var d=a('<div class="question-container" />');return c.append(d),a("#local-teameval-questions").append(c),this.addEditingControls(c),c},addEditingControls:function(b){var c=this;d.render("local_teameval/question_actions",{locked:j}).done(function(d){var e=a(d);b.prepend(e),e.find(".edit").click(function(){c.editQuestion(b)}),e.find(".delete").click(function(){c.deleteQuestion(b)}),b.hasClass("editing")&&e.hide()}),d.render("local_teameval/save_cancel_buttons",{}).done(function(d){var e=a(d);e.find(".save").click(function(){c.saveQuestion(b)}),e.find(".cancel").click(function(){void 0===b.data("questionid")?c.deleteQuestion(b):c.showQuestion(b)}),b.append(e),b.hasClass("editing")||e.hide()})},editQuestion:function(a,b){var c=a.data("editingcontext")||{},e=a.data("questiontype");c._id=g,c._self=i,b&&(c._newquestion=!0),a.find(".local-teameval-question-actions").hide(),d.render("teamevalquestion_"+e+"/editing_view",c).done(function(b,c){var e=a.find(".question-container");a.addClass("editing"),e.html(b).off(),d.runTemplateJS(c),a.find(".local-teameval-save-cancel-buttons").show()}).fail(function(){a.find(".local-teameval-question-actions").show()})},saveQuestion:function(a){var b=a.find(".question-container"),c=a.index(".local-teameval-question"),d=b.triggerHandler("save",c);d.done(function(b,c,d){a.data("questionid",b),a.data("editingcontext",d),a.data("submissioncontext",c),this.showQuestion(a)}.bind(this)),d.fail(function(){}.bind(this))},showQuestion:function(a){var b=a.data("submissioncontext")||{},c=a.data("questiontype");b._id=g,b._editing=!0,d.render("teamevalquestion_"+c+"/submission_view",b).done(function(b,c){a.removeClass("editing"),a.find(".question-container").html(b).off(),a.find(".local-teameval-save-cancel-buttons").hide(),a.find(".local-teameval-question-actions").show(),d.runTemplateJS(c)}).fail(f.exception)},deleteQuestion:function(a){if(void 0===a.data("questionid"))a.remove();else{var b=a.find(".question-container");b.triggerHandler("delete").done(function(){a.remove()}).fail(f.exception)}},setOrder:function(){var b=a("#local-teameval-questions li").map(function(){return{type:a(this).data("questiontype"),id:a(this).data("questionid")}}).filter(function(){return void 0!==this}).get(),c=e.call([{methodname:"local_teameval_questionnaire_set_order",args:{id:g,order:b}}]);c[0].done(function(){}).fail(f.exception)},addFromTemplate:function(){var a=l.data("template-id");if(a>0){n.prop("disabled",!0);var b=this,c=e.call([{methodname:"local_teameval_add_from_template",args:{from:a,to:g}}]);c[0].done(function(a){b.addQuestions(a),o(),l.val("")}),c[0].fail(f.exception)}},addQuestions:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=this.addQuestion(c.type);d.data("questionid",c.questionid),d.data("editingcontext",c.editingcontext),d.data("submissioncontext",c.submissioncontext),this.showQuestion(d)}},initialised:function(){return m||(m=a.Deferred()),m.promise()},initialise:function(b){g=b.id,i=b.self,j=b.locked,h=b.subplugins,k=b.addButton;var c=b.templateSearch,d=b.templateIO,p=this;a("#local-teameval-questions .local-teameval-question").each(function(){p.addEditingControls(a(this))}),d.find(".template-download").click(function(){window.location.href=b.download}),j||(a("#local-teameval-questions").sortable({handle:".local-teameval-question-actions .move",axis:"y",update:function(){p.setOrder()}}),k.find("a").click(p.preAddQuestion.bind(p)),n=c.find("button"),n.click(p.addFromTemplate.bind(p)),n.prop("disabled",!0),o=b.templatePreviewFunction,l=c.find("input"),l.autocomplete({minLength:2,source:function(a,b){var c=e.call([{methodname:"local_teameval_template_search",args:{id:g,term:a.term}}]);c[0].done(function(a){b(a)}),c[0].fail(f.exception)},focus:function(a,b){return l.val(b.item.title),!1},select:function(a,b){return b.item?(l.val(b.item.title),l.data("template-id",b.item.id),n.prop("disabled",!1),o(b.item)):(n.prop("disabled",!0),o()),!1}}),l.focus(function(){l.val(""),n.prop("disabled",!0),o()}),l.change(function(){n.prop("disabled",!0),o()}),l.autocomplete("instance")._renderItem=b.autocompleteRenderFunction,d.find(".template-upload").click(function(){var a=M.core_filepicker.instances[b.filepickerid];a.options.formcallback=function(a){var c=e.call([{methodname:"local_teameval_upload_template",args:{id:g,itemid:b.filepickeritemid,file:a.file}}]);c[0].done(function(a){p.initialised().done(function(){p.addQuestions(a)})}),c[0].fail(Notification.exception)},a.show()}),m||(m=a.Deferred()),m.resolve())}}});